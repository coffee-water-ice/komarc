# 10/11 - ì•Œë¼ë”˜api ê²€ìƒ‰ ì‹¤íŒ¨ì‹œ í¬ë¡¤ë§ í•¨ìˆ˜ ë° êµ¬ kdc ì¶”ì¶œ ì½”ë“œ ì‚­ì œ
# ğŸ“š ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ ì¶”ì¶œ
def extract_category_keywords(category_str):
    keywords = set()
    lines = category_str.strip().splitlines()
    for line in lines:
        parts = [x.strip() for x in line.split('>') if x.strip()]
        if parts:
            keywords.add(parts[-1])
    return list(keywords)

# âœ… ê²€ìƒ‰ì–´ í™•ë³´(ìš°ì„ ìˆœìœ„: search_query â†’ digits â†’ isbn)
search_query = (search_query if 'search_query' in locals() and search_query else
                (digits if 'digits' in locals() and digits else
                 (isbn if 'isbn' in locals() and isbn else "")))

if not search_query:
    raise RuntimeError("ì•Œë¼ë”˜ ê²€ìƒ‰ìš© ê²€ìƒ‰ì–´(search_query/isbn)ê°€ ì—†ìŠµë‹ˆë‹¤.")

# âœ… URL ìƒì„±
url = ALADIN_SEARCH_URL.format(query=quote_plus(search_query))
html = requests.get(url, headers=HEADERS, timeout=DEFAULT_TIMEOUT).text

# 2) íŒŒì‹±
from bs4 import BeautifulSoup
soup = BeautifulSoup(html, "html.parser")

# 3) ì²« ê²°ê³¼ ë§í¬ ì¶”ì¶œ(í˜ì´ì§€ DOMì— ë§ì¶° CSS ì„ íƒì/ì •ê·œì‹ì€ ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
first_link = soup.select_one("a.bo3")  # ì˜ˆì‹œ: ì•Œë¼ë”˜ ê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ì˜ íƒ€ì´í‹€ ë§í¬
if not first_link:
    raise RuntimeError("ì•Œë¼ë”˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í•¨")

detail_url = urljoin("https://www.aladin.co.kr", first_link.get("href", ""))

# 4) ìƒì„¸ í˜ì´ì§€ ê¸ê¸°
detail_html = requests.get(detail_url, headers=HEADERS, timeout=DEFAULT_TIMEOUT).text
detail = BeautifulSoup(detail_html, "html.parser")
# ... ì œëª©/ì €ì/ì¶œíŒì‚¬/ë°œí–‰ì¼ ë“± ê¸°ì¡´ íŒŒì‹± ê·œì¹™ ì ìš©

def to_isbn13(x: str) -> str:
    d = re.sub(r"\D", "", x or "")
    if len(d) == 13: return d
    if len(d) == 10:
        core = "978" + d[:-1]
        s = sum(int(n) * (1 if i % 2 == 0 else 3) for i, n in enumerate(core))
        return core + str((10 - (s % 10)) % 10)
    raise ValueError(f"ISBN ê¸¸ì´ ì˜¤ë¥˜: {x!r}")

item = fetch_aladin_item(to_isbn13(actual_isbn))


# ğŸ”§ GPT ê¸°ë°˜ KDC ì¶”ì²œ (OpenAI 1.6.0+ ë°©ì‹ìœ¼ë¡œ ë¦¬íŒ©í† ë§)
def recommend_kdc(title, author, api_key):
    try:
        # ğŸ”‘ ë¹„ë°€ì˜ ì—´ì‡ ë¡œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ê¹¨ì›ë‹ˆë‹¤
        client = OpenAI(api_key=api_key)

        # ğŸ“œ ì£¼ë¬¸ë¬¸ì„ ì¤€ë¹„í•˜ê³ 
        prompt = (
            f"ë„ì„œ ì œëª©: {title}\n"
            f"ì €ì: {author}\n"
            "ì´ ì±…ì˜ ì£¼ì œë¥¼ ê³ ë ¤í•˜ì—¬ í•œêµ­ì‹­ì§„ë¶„ë¥˜(KDC) ë²ˆí˜¸ í•˜ë‚˜ë¥¼ ì¶”ì²œí•´ ì£¼ì„¸ìš”.\n"
            "ì •í™•í•œ ìˆ«ìë§Œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ê°„ë‹¨íˆ ì‘ë‹µí•´ ì£¼ì„¸ìš”:\n"
            "KDC: 813.7"
        )

        # ğŸ§  GPTì˜ ì§€í˜œë¥¼ ì†Œí™˜
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
        )

        # â† ì—¬ê¸°ë¶€í„° ë³´ê°•ëœ ë¶€ë¶„
        msg = response.choices[0].message
        content = getattr(msg, "content", None)
        if content is None and isinstance(msg, dict):
            content = msg.get("content", "")
        content = content or ""

        # âœ‚ï¸ â€œKDC:â€ ë’¤ì˜ ìˆ«ìë§Œ êº¼ë‚´ì„œ ëŒë ¤ë“œë¦½ë‹ˆë‹¤
        for line in content.splitlines():
            if "KDC:" in line:
                return line.split("KDC:")[1].strip()

    except Exception as e:
        st.warning(f"ğŸ§  GPT ì˜¤ë¥˜: {e}")

    # ğŸ›¡ï¸ ë§Œì•½ ì‹¤íŒ¨í•˜ë©´ ë””í´íŠ¸ â€œ000â€
    return "000"
